# Remember the selected spools across printer reboots
[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_macro _SPOOLMAN_CFG]
variable_tools: ['T0','T1','T2','T3']
gcode:
  # no g-code, this is just a conveniet "array" because I don't like to repeat my sef.
  RESPOND PREFIX="ðŸ§¶" MSG="Nothing to see here"

[gcode_macro SET_ACTIVE_SPOOL_MAPPED]
description: Activates spool ID based on tool index, optionally using the extruder map for verification.
gcode:
  # --- Check if TOOL_INDEX parameter is provided ---
  {% if not params.TOOL_INDEX is defined %}
    RESPOND MSG="Error in SET_ACTIVE_SPOOL_MAPPED: Parameter 'TOOL_INDEX' is required."
    return
  {% endif %}

  {% set tool_index = params.TOOL_INDEX|int %}
  {% set spool_macro_name = "" %}
  {% set map_table_key = 'extruder_map_table' %}
  
  # --- Check for existence of the extruder map table (List) ---
  {% if printer.print_task_config is defined and map_table_key in printer.print_task_config %}
    {% set map_table = printer.print_task_config[map_table_key] %}

    # Check if the tool_index is a valid index for the map_table list
    {% if tool_index < 0 or tool_index >= map_table|length %}
      RESPOND MSG="Error: extruder_map_table list exists but Tool Index {tool_index} is out of range (list size: {map_table|length}). Cannot determine spool macro."
      return
    {% endif %}
    # Use the tool_index directly to get the physical extruder index from the list
    {% set extruder_index = map_table[tool_index]|int %}
    # The Spoolman macro name is based on the physical extruder index
    {% set spool_macro_name = 'T' ~ extruder_index %}
    
    RESPOND MSG="Tool Index {tool_index} maps to Extruder Index {extruder_index}."

  {% else %}
    # Map table does not exist. Use the tool_index directly as the spool macro index (Fallback).
    {% set spool_macro_name = 'T' ~ tool_index %}
    
    RESPOND MSG="extruder_map_table not found. Using Tool Index {tool_index} directly as spool macro name {spool_macro_name}."
  {% endif %}

  {% set spool_macro_key = 'gcode_macro ' ~ spool_macro_name %}
  
  # --- Check if the required spool macro (e.g., T0, T1) exists ---
  {% if spool_macro_key not in printer %}
    RESPOND MSG="Error: Spool macro {spool_macro_name} (derived from map/index) not configured."
    return
  {% endif %}
  
  {% set spool_macro_object = printer[spool_macro_key] %}

  # --- Check if the 'spool_id' variable exists on the macro ---
  {% if spool_macro_object.spool_id is not defined %}
    RESPOND MSG="Error: 'spool_id' variable missing in macro {spool_macro_name}."
    return
  {% endif %}
  
  {% set spool_id_to_set = spool_macro_object.spool_id %}
  
  # --- EXECUTION LOGIC ---
  
  # Check for a valid spool ID (not 'None' string or None object)
  {% if spool_id_to_set is defined and spool_id_to_set and spool_id_to_set != "None" %}
    # Call the main spool setting macro
    SET_ACTIVE_SPOOL ID={spool_id_to_set}
    
    RESPOND MSG="Spool for {spool_macro_name} set to ID: {spool_id_to_set}"
  {% else %}
    # Clear the active spool
    CLEAR_ACTIVE_SPOOL
    
    RESPOND MSG="No spool mapped for {spool_macro_name}. Cleared active spool."
  {% endif %}


# main Spool selection macro
[gcode_macro SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID is defined %}
    {% set id = params.ID|int %}
    {action_call_remote_method("spoolman_set_active_spool", spool_id=id)}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method("spoolman_set_active_spool", spool_id=None)}

# Only touch tools that exist AND actually expose .spool_id
[gcode_macro CLEAR_ALL_SPOOLS]
gcode:
  {action_call_remote_method("spoolman_set_active_spool", spool_id=None)}

  RESPOND PREFIX="ðŸ§¶" MSG="Clearing all spools"

  {% set tools = printer["gcode_macro _SPOOLMAN_CFG"].tools %}
  {% for tool in tools %}
    {% set macro = "gcode_macro " ~ tool %}
    {% if macro in printer and printer[macro].spool_id is defined %}
      SET_GCODE_VARIABLE MACRO={tool} VARIABLE=spool_id VALUE="None"
    {% endif %}
  {% endfor %}

  UPDATE_DELAYED_GCODE ID=SAVE_SELECTED_SPOOLS DURATION=1

[delayed_gcode SAVE_SELECTED_SPOOLS]
gcode:
  {% set tools = printer["gcode_macro _SPOOLMAN_CFG"].tools %}

  {% for tool in tools %}
    {% set macro = "gcode_macro " ~ tool %}
    {% set vname = tool|lower ~ "__spool_id" %}

    {% if macro in printer and printer[macro].spool_id is defined %}
      {% set sid = printer[macro].spool_id|default("") %}
    {% else %}
      {% set sid = "" %}
    {% endif %}

    {% if sid != "" %}
      #RESPOND PREFIX="ðŸ§¶" MSG="Saving spool for {vname}: {sid}"
      SAVE_VARIABLE VARIABLE={vname} VALUE="{sid}"
    {% else %}
      #RESPOND PREFIX="ðŸ§¶" MSG="Clearing spool for {vname}"
      SAVE_VARIABLE VARIABLE={vname} VALUE="None"
    {% endif %}
  {% endfor %}

[gcode_macro SAVE_CURRENT_SPOOLS]
gcode:
  RESPOND PREFIX="ðŸ§¶" MSG="Current spools saved"
  UPDATE_DELAYED_GCODE ID=SAVE_SELECTED_SPOOLS DURATION=0.01

[delayed_gcode RESTORE_SELECTED_SPOOLS]
initial_duration: 0.1
gcode:
  {% set svv = printer.save_variables.variables %}
  RESPOND PREFIX="ðŸ§¶" MSG="Restoring spools selection"
  {% for object in printer %}
    {% if object.startswith('gcode_macro ') and printer[object].spool_id is defined %}
      {% set macro = object.replace('gcode_macro ', '') %}
      {% set var = (macro + '__SPOOL_ID')|lower %}
      {% if svv[var] is defined %}
        SET_GCODE_VARIABLE MACRO={macro} VARIABLE=spool_id VALUE={svv[var]}
      {% endif %}
    {% endif %}
  {% endfor %}


# Per tool spool config
[gcode_macro T0]
rename_existing: T0.10001
variable_spool_id: None
gcode:
  SET_ACTIVE_SPOOL_MAPPED TOOL_INDEX=0
  T0.10001 {rawparams}

[gcode_macro T1]
rename_existing: T1.10001
variable_spool_id: None
gcode:
  SET_ACTIVE_SPOOL_MAPPED TOOL_INDEX=1
  T1.10001 {rawparams}

[gcode_macro T2]
rename_existing: T2.10001
variable_spool_id: None
gcode:
  SET_ACTIVE_SPOOL_MAPPED TOOL_INDEX=2
  T2.10001 {rawparams}

[gcode_macro T3]
rename_existing: T3.10001
variable_spool_id: None
gcode:
  SET_ACTIVE_SPOOL_MAPPED TOOL_INDEX=3
  T3.10001 {rawparams}
